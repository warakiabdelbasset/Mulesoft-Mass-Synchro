<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd">
	<flow name="put-accountsFlow" doc:id="b8b746d5-ec80-4f3b-bbd6-75225db1cf1a" >
		<ee:transform doc:name="Size of payload" doc:id="67135908-a387-4396-977b-82ceae6f7e82">
			<ee:message>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="sizeOfPayload" ><![CDATA[%dw 2.0
output application/java
---
sizeOf(payload)]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="577ddd00-3995-4725-90d4-bbddba9acb37" >
			<when expression="#[vars.sizeOfPayload &lt;= 1]">
				<flow-ref doc:name="Flow Reference" doc:id="e24ebd72-4f66-4afb-ae0b-9452e2d7c4fc" name="normalUpsert"/>
			</when>
			<when expression="#[vars.sizeOfPayload &gt; 1]">
				<flow-ref doc:name="Flow Reference" doc:id="ae78ba0e-4a0d-4156-a826-17fcda6ad02d" name="bulkUpsert"/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="1b9a1516-e313-42c9-84ab-aaf258f3122f" message="#[payload]"/>
			</otherwise>
		</choice>
	</flow>
	<flow name="normalUpsert" doc:id="2fb30ce0-c8bd-4716-8aa2-aefe4a16a016" >
		<set-variable value="#[payload]" doc:name="Set Variable" doc:id="ae882c4e-554d-435b-98c9-e185c204edc9" variableName="data"/>
		<salesforce:upsert objectType="Account" externalIdFieldName="France_Account_Id__c" doc:name="Upsert" doc:id="6c2664d4-c291-460e-a7be-34d73373cc9c" config-ref="Salesforce_SmarkGlobal">
		</salesforce:upsert>
		<choice doc:name="Choice" doc:id="a493562f-fadd-4bb9-919c-3f457a3d7767">
			<when expression="#[(payload.items.payload[0].success == true and payload.items.payload[0].created == true)]">
				<ee:transform doc:name="Success" doc:id="f9cca636-ba55-47a9-8364-e634d3b5de76">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	
	Status: "Record Created Successfully."
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</when>
			<when expression="#[(payload.items.payload[0].success == true and payload.items.payload[0].created == false)]">
				<ee:transform doc:name="Transform Message" doc:id="26b1a5cc-6f15-4aa1-8112-977c8bee0076">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	
	Status: "Record Updated Successfully."
	
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<ee:transform doc:name="failed" doc:id="a87a3088-6925-4f3b-a2d1-2be41777825b">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	
	Status : "Failed to Create or Update record.",
	error: payload.items.statusCode
	
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="55e3f41c-1154-4e8f-96de-26793455e345" type="SALESFORCE:CONNECTIVITY">
				<logger level="INFO" doc:name="Logger" doc:id="e9441ee8-e3bc-4a54-adca-107eafcd1619" message="#[error.description]"/>
				<ee:transform doc:name="Transform Message" doc:id="74947aba-c69c-4387-9ec5-e18a308195f3" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	errorDescription: 'Connection not established.',
	errorType: 'SALESFORCE:CONNECTIVITY',
	errorSeverity: 'MEDIUM',
	nativeError: {
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="f76b2440-c70b-4afe-9028-ea958d071f18" type="SALESFORCE:INVALID_INPUT">
				<logger level="INFO" doc:name="Logger" doc:id="1594edd7-2f9e-4dff-ad75-ca2a946ac186" message="#[error.description]"/>
				<ee:transform doc:name="Transform Message" doc:id="a80aae9b-38e9-4a0b-9eed-4d747fc7db9a" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	errorDescription: 'INVALID INPUT',
	errorType: 'SALESFORCE:INVALID_INPUT',
	errorSeverity: 'MEDIUM',
	nativeError: {
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="95b7e6ca-7e50-496a-abcb-908b0558c87d" type="ANY">
				<logger level="INFO" doc:name="Logger" doc:id="c5f22be2-b197-49cb-a4e5-d69e8d1fb71a" message="#[error.description]"/>
				<ee:transform doc:name="Transform Message" doc:id="eba00f4b-e688-439f-b169-5e3b72648b3e" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	nativeError: {
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="bulkUpsert" doc:id="630401b6-b14d-43a6-9c2d-c55afcb1fb6b" >
		<ee:transform doc:name="Transform to CSV" doc:id="9f8b9d5d-4b98-406a-9703-277d116d2ef8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/csv
---
payload map (item) -> {
	"Ownership" : item.Ownership,
	"France_Account_Id__c": item.Id,
    "Description": item.Description,
    "BillingCity": item.BillingCity,
    "Rating": item.Rating,
    "Website": item.Website,
    "NumberOfEmployees": item.NumberOfEmployees,
    "type": item."type",
    "Name": item.Name,
    "ShippingStreet": item.ShippingStreet,
    "AccountNumber": item.AccountNumber,
    "Industry": item.Industry,
    "BillingStreet": item.BillingStreet,
    "Phone": item.Phone,
    "TickerSymbol": item.TickerSymbol,
    "country__c": item.country__c,
    "BillingState": item.BillingState,
    "AnnualRevenue": item.AnnualRevenue
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<salesforce:create-job-bulk-api-v2 objectType="Account" operation="upsert" doc:name="Create job bulk api v 2" doc:id="ab96fa84-e701-4e5b-bc65-5515fa7f69af" config-ref="Salesforce_SmarkGlobal" externalIdFieldName="Id"/>
		<set-variable value="#[payload.id]" doc:name="JobId" doc:id="c646890b-6252-4da8-bdd3-cb2d9c520eff" variableName="JobId"/>
		<until-successful maxRetries="5" doc:name="Until Successful" doc:id="961d93fd-6a3a-4f07-9031-411c66f2c9f4" >
			<salesforce:get-job-state-bulk-api-v2 doc:name="Get job state bulk api v 2" doc:id="b0549f19-c280-4870-8edb-5d7951a33900" config-ref="Salesforce_SmarkGlobal" id="#[vars.JobId]"/>
			<set-variable value="#[payload.state]" doc:name="JobState" doc:id="b02a821e-28fc-49f2-ac7c-42efc89db3c6" variableName="JobState"/>
			<choice doc:name="Choice" doc:id="09ac8fea-bdb4-45e9-a775-e32e35453a54" >
				<when expression='#[vars.JobState == "JobComplete"]'>
					<salesforce:retrieve-job-failed-results-bulk-v2 doc:name="Retrieve job failed results bulk v 2" doc:id="eff16a4e-77c8-42d4-bb6a-4c08317335a7" config-ref="Salesforce_SmarkGlobal" id="#[vars.JobId]" target="failed_results"/>
					<salesforce:retrieve-job-successful-results-bulk-v2 doc:name="Retrieve job successful results bulk v 2" doc:id="3154fd65-3014-4706-b57d-36817f57b179" config-ref="Salesforce_SmarkGlobal" id="#[vars.JobId]" target="success_results"/>
					<salesforce:retrieve-job-unprocessed-results-bulk-v2 doc:name="Retrieve job unprocessed results bulk v 2" doc:id="f8dc5ba2-8865-41d2-b6cb-b5c27be5fc87" config-ref="Salesforce_SmarkGlobal" id="#[vars.JobId]" target="unprocess_results"/>
					<ee:transform doc:name="return message" doc:id="495d4259-7b36-452c-a04e-916eef129f57" >
						<ee:message >
							<ee:set-payload ><![CDATA[%dw 2.0
output application/json 
---

{
	"Nbr of success record": sizeOf(vars.success_results) ++ "Records",
	"Nbr of unprocess record": sizeOf(vars.unprocess_results)++ "Records",
	"Nbr of failed record": sizeOf(vars.failed_results) ++ "Records" ++ "message error : " ++ vars.failed_results.errorMessage,
	"k": vars.failed_results.errorMessage,
	
	}
]]></ee:set-payload>
						</ee:message>
					</ee:transform>
					<logger level="INFO" doc:name="Logger" doc:id="442c54c0-cb3b-44e5-a8d1-f0aab0552739" message="#[payload]"/>
				</when>
				<when expression='#[vars.JobState == "Failed"]'>
					<ee:transform doc:name="return message" doc:id="99e98403-0ac0-410b-8b58-3240fdace2ae" >
						<ee:message >
							<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---

	{"Job State" : "Update / Create failed"}
]]></ee:set-payload>
						</ee:message>
					</ee:transform>
				</when>
				<otherwise >
					<raise-error doc:name="Raise error" doc:id="9570dcbf-ee4f-481e-9fe2-0f3c3ff7d708" type="APP:ANY"/>
				</otherwise>
			</choice>
		</until-successful>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="169bc918-0393-4e54-bd40-7d2c2236a8af" type="SALESFORCE:CONNECTIVITY">
				<logger level="INFO" doc:name="Logger" doc:id="2f87c5a4-d5e9-4064-bb40-c7ed172dd6f2" message="#[error.description]"/>
				<ee:transform doc:name="Transform Message" doc:id="e0a90402-b716-4425-98c8-2dc967d10750" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	errorDescription: 'Connection not established.',
	errorType: 'SALESFORCE:CONNECTIVITY',
	errorSeverity: 'MEDIUM',
	nativeError: {
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e74ef739-93fa-4f9a-9e0e-a41f9c24bd46" type="SALESFORCE:INVALID_INPUT">
				<logger level="INFO" doc:name="Logger" doc:id="46dfa16e-9a61-4135-8d91-c06eeed19d6f" message="#[error.description]"/>
				<ee:transform doc:name="Transform Message" doc:id="1106f831-3ee9-4bcb-aac9-16dcb767b838" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	errorDescription: 'INVALID INPUT',
	errorType: 'SALESFORCE:INVALID_INPUT',
	errorSeverity: 'MEDIUM',
	nativeError: {
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="da44e749-2894-45b1-82ea-70df889892de" type="ANY">
				<logger level="INFO" doc:name="Logger" doc:id="81486592-d39d-41f5-9874-dceb9c1a719d" message="#[error.description]"/>
				<ee:transform doc:name="Transform Message" doc:id="dcf77510-170e-4786-b143-0b427c5b439c" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	nativeError: {
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</on-error-propagate>
		</error-handler>
	</flow>
</mule>
