<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">

	<error-handler name="global-error_handler"
		doc:id="c0353717-5c98-4f12-aaa9-968055519542">

		<!-- APIKit router related exceptions -->

		<!-- HTTP Requester Related error handling -->

		<!-- Streaming related exception -->

		<!-- Generic CONNECTIVITY Related Exception handling start. Order matters -->
		<!-- Generic CONNECTIVITY Exception handling end -->


		<!-- If none of the above matches then handle a the exception using generic 
			handler -->
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="78d72e42-446a-4aa7-9bdc-5dba4638ccf5" type="ANY" >
			<flow-ref doc:name="frk-buildException" doc:id="81854415-b7demo-4815-919a-61ecb737d1bb" name="frk-buildException" />
		</on-error-continue>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="f162b6b0-a994-4375-9dbf-0021ea18225d" type="FRK:EXCEPTION">
			<flow-ref doc:name="frk-auditError" doc:id="ed447575-bed3-4ada-8715-e93af751b79f" name="frk-auditError" />
		</on-error-continue>

	</error-handler>

	<sub-flow name="frk-buildException" doc:id="3bc4757e-677b-43a7-92b5-bfdf358b32dc" >
		<ee:transform doc:name="frk_exception" doc:id="dfefe88d-5339-49fa-8e07-433b69398a32" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="frk_exception" ><![CDATA[%dw 2.0
output application/java
---
{
	errorCorrelationId: vars.frk_tracking.correlationId,
	errorTimestamp: now() as String { format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" },
	errorDescription: "Unhandled exception - errorType: " ++ error.errorType.identifier as String default "unknown" ++ " - see native error details",
	errorCode: 'FRK-0000',
	errorType: 'T',
	errorSeverity: 'MEDIUM',
	nativeError: 
	{
		description: error.description,
		detailedDescription: error.detailedDescription,
		errorType: error.errorType,
		
		errorMessage: error.errorMessage,
		childErrors: error.childErrors
	}
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="frk-auditError" doc:id="e2c7a193-6c27-4c0c-a0ca-cf70b2df6039" name="frk-auditError"/>
	</sub-flow>
	<sub-flow name="frk-auditError"
		doc:id="463ad703-d703-437f-93f0-789f90b4f494">
		<choice doc:name="Choice" doc:id="b6126299-1750-4f65-b296-939b9a286947" >
			<when expression='vars.frk_serviceStatus == null'>
				<set-variable value="#[%dw 2.0
output application/java
---
{
	serviceName: 'unknown',
	serviceType: &quot;api&quot;
}]" doc:name="setService" doc:id="0fe57f4b-b7e3-4247-a518-edecccdemob64d" variableName="frk_setContext_in" />
				<flow-ref doc:name="setContext" doc:id="0022a61e-f8f8-4e30-ae6e-be99596d21ac" name="frk-setContext" />
			</when>
		</choice>
		<choice doc:name="Choice" doc:id="d509579f-faf4-4dff-a488-e01e4a52440d" >
			<when expression='vars.frk_serviceStatus == "init"'>
				<flow-ref doc:name="frk-logStart" doc:id="5e238ed1-9b49-4d9f-abc0-4e0ca10cdfbd" name="frk-logStart" />
			</when>
		</choice>
		<flow-ref doc:name="frk-logError" doc:id="ddemod0417-8a95-45e2-b49b-60c569015b67" name="frk-logError"/>
		<choice doc:name="Choice" doc:id="f461bde6-fa8c-4314-89c7-f08489bb68ec" >
			<when expression='vars.frk_exception.isNonFatal=="true"'>
				<flow-ref doc:name="frk-logEnd" doc:id="b695b4d2-7de6-4bab-9659-5ace27aa0c7f" name="frk-logEnd"/>
			</when>
		</choice>
	</sub-flow>

</mule>
